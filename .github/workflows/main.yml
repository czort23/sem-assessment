build:
  name: Build and Start Using docker-compose
  runs-on: ubuntu-22.04

  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'adopt'

    - name: Package application
      run: mvn package -DskipTests

    - name: Start MySQL service
      run: docker compose up -d db

    - name: Wait for MySQL to initialize
      run: |
        echo "⏳ Waiting for MySQL to be ready..."
        for i in {1..10}; do
          if docker exec $(docker ps -qf "name=db") mysqladmin ping -h localhost --silent; then
            echo "✅ MySQL is ready!"
            break
          fi
          echo "MySQL not ready yet... waiting 5s"
          sleep 5
        done

    - name: Run app container
      run: docker compose run --rm app --no-menu

    - name: Stop containers
      if: always()
      run: docker compose down
