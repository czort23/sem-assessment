name: A workflow for SEM App

on:
  push:
    branches:
      - develop

permissions:
  contents: write

jobs:
  UnitTests:
    name: Unit Tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Unit Tests
        run: mvn -Dtest="com.napier.sem.dao.*Test,com.napier.sem.service.*Test" test


  IntegrationTests:
    name: Integration Tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build DB Docker image
        run: docker build -t db ./db

      - name: Start DB container
        run: |
          docker run -d \
            --name sem-db \
            -p 33060:3306 \
            -e MYSQL_ROOT_HOST=% \
            -e MYSQL_ROOT_PASSWORD=example \
            -e MYSQL_DATABASE=world \
            db
          sleep 25

      - name: Integration Tests
        run: mvn -Dtest="com.napier.sem.integration.*Test" test

      - name: Stop and clean up
        if: always()
        run: |
          docker stop sem-db || true
          docker rm sem-db || true
          docker image rm db || true


  build:
    name: Build Docker Images
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Package JAR (skip tests)
        run: mvn package -DskipTests

      - name: Build Docker images (compose)
        run: docker compose build

      - name: Deploy Release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          prerelease: false
          automatic_release_tag: "latest"
          files: |
            ./target/*.jar
